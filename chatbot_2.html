<!DOCTYPE HTML>
<html lang="en" class="light" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>We have the technology. - Ryan&#x27;s Personal Blog</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body class="sidebar-visible no-js">
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('light')
            html.classList.add(theme);
            var body = document.querySelector('body');
            body.classList.remove('no-js')
            body.classList.add('js');
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var body = document.querySelector('body');
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            body.classList.remove('sidebar-visible');
            body.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">The Six Million Dollar Chad</li><li class="chapter-item expanded "><a href="chatbot_1.html"><strong aria-hidden="true">1.</strong> We can rebuild him.</a></li><li class="chapter-item expanded "><a href="chatbot_2.html" class="active"><strong aria-hidden="true">2.</strong> We have the technology.</a></li><li class="chapter-item expanded affix "><li class="part-title">ServiceNow</li><li class="chapter-item expanded "><a href="servicenow_1.html"><strong aria-hidden="true">3.</strong> List Choice UI Action on Database View</a></li><li class="chapter-item expanded "><a href="servicenow_2.html"><strong aria-hidden="true">4.</strong> Portal UI Actions, Part 1</a></li><li class="chapter-item expanded "><a href="servicenow_3.html"><strong aria-hidden="true">5.</strong> Portal UI Actions, Part 2</a></li><li class="chapter-item expanded "><a href="servicenow_4.html"><strong aria-hidden="true">6.</strong> Passing Values to Arrays During GlideRecord Queries</a></li><li class="chapter-item expanded affix "><li class="part-title">Miscellaneous</li><li class="chapter-item expanded "><a href="javascript_1.html"><strong aria-hidden="true">7.</strong> A Solution to the Happy Numbers Problem in JavaScript</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Ryan&#x27;s Personal Blog</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="we-have-the-technology"><a class="header" href="#we-have-the-technology">We have the technology.</a></h1>
<p><em>16 March 2024</em></p>
<p>Yesterday, we built the initial queuing system to handle task notices.</p>
<p>First, the end result:</p>
<p><img src="images/chatbot_2_1.png" alt="Image" /></p>
<p>There's a new class in the mix: <code>ChatQueue</code>. Right now, it's just an extension of asyncio's Queue. It does basically nothing special except logging as well as enforcing a particular <code>QueueMessage</code> dataclass.</p>
<pre><code class="language-python">class ChatQueue(Queue):

    @dataclass
    class QueueMessage:
        text: str
        msgtype: str

    async def put(self, queue_message: QueueMessage):
        log.debug("Put a message in the queue.", extra = {"queue_message": queue_message})
        await super().put(queue_message)

    async def get(self) -&gt; QueueMessage:
        queue_message = await super().get()
        log.debug("Got a message from the queue.", extra = {"queue_message": queue_message})
        return queue_message
</code></pre>
<p>The intent here is that, should we require extra processing on getting or setting messages, we will now be able to take care of that. But at least when you <code>put</code> you know you have to pass in a QueueMessage, and when you <code>get</code> you know you'll get a QueueMessage back.</p>
<h2 id="wheres-chatqueue-used"><a class="header" href="#wheres-chatqueue-used">Where's ChatQueue used?</a></h2>
<p>The <code>ChatSession</code> class creates a new <code>output_queue</code> of type ChatQueue. Eventually we want to output the final response to this queue as well, probably later today, but right now we're just passing it into the <code>PluginInterface.call_tools</code> function.</p>
<p>This means we had to restructure the PluginInterface abstract base class to accept a ChatQueue within the <code>__call__</code> definition, as well as the subclass plugins, and we pass it along when we call each plugin.</p>
<p>So for example, our testing plugin of <code>GetDateTime</code> which will eventually be superceded by just passing the time in with the prompt (but is very nice for testing plugins at the moment)...</p>
<pre><code class="language-python">    async def __call__(self, queue: ChatQueue, **kwargs) -&gt; str:
        await queue.put(
            queue.QueueMessage("Chad is checking his calendar...", "notice")
        )
        tz = pytz.timezone(kwargs["timezone"])
        now = datetime.datetime.now(tz)
        return now.strftime("%A %d %b %Y, %I:%M%p")
</code></pre>
<p>Great! How do messages get consumed from the queue? Well, that implementation is left up to our Message Interface of choice. Each Message Interface can choose how to handle different QueueMessage msgtypes.</p>
<p>In the Matrix reference implementation, we've now got the <code>queue_consumer</code> which starts up as soon as a <code>message_callback</code> is initiated (when it notices a new message has been sent into the room).</p>
<p>While true, we <code>get</code> a message from the queue, and if it's of type notice we send an <code>m.room.message</code> of type <code>m.notice</code> into the thread.</p>
<p>Then we're processing the main message, which is still not in the queue yet but will be soon, we <code>join</code> any pending tasks, and <code>cancel</code> the consumer.</p>
<h2 id="but-why-should-the-main-output-also-be-in-the-queue"><a class="header" href="#but-why-should-the-main-output-also-be-in-the-queue">But why should the main output also be in the queue?</a></h2>
<p>Here's our line of thinking:</p>
<ol>
<li>
<p>It's nicer if everything comes from one location, implementation-wise. I want it to be easy to build other Message Interfaces off of this.</p>
</li>
<li>
<p>Ordering - we can ensure the notice type messages happen before the response type messages.</p>
</li>
</ol>
<h2 id="next-steps"><a class="header" href="#next-steps">Next Steps</a></h2>
<p>Here's where we are, and where I want to go next, given the previous post.</p>
<ul>
<li><input disabled="" type="checkbox"/>
Check token counts for plugins, as this may be where my secret extra token usage is going</li>
<li><input disabled="" type="checkbox" checked=""/>
Build a basic queuing system</li>
<li><input disabled="" type="checkbox"/>
Make the main message output also go into the queuing system</li>
<li><input disabled="" type="checkbox"/>
Investigate JSON Responses for output modes and self-thought</li>
<li><input disabled="" type="checkbox"/>
Build a Prompt Manager which can change the prompt based on output modes</li>
<li><input disabled="" type="checkbox"/>
Based on output modes, certain plugins should or should not be available to Chad</li>
</ul>
<p>Okay, so that last one -- basically, if we have a bunch of plugins, we don't want to overwhelm Chad every time with every plugin, right? But if plugins are only available in certain output modes, we can control which ones we send to Chad depending on whether Chad thinks he needs plugin help.</p>
<p>Maybe there's the "reference" mode where we provide the plugins to call Wikipedia or other external knowledge, and the "phone a friend" mode where Chad can call other models and pass in his own information for a response. That sort of thing.</p>
<p>I'd also like a "user info" mode where we additionally pass in the details of who's talking to Chad, and he can pass that in to retrieve additional information. Like, "I need to check the user's calendar", so he passes in the user who's talking to him, and he gets back the user account and a list of plugins that are available like "calendar" "location" or whatever, and then he can choose the appropriate plugin, passing in the user account, and the plugins cross-reference some sort of data structure that says "aha, for this user account, we have the API details for the user's Google Calendar, so we'll call it and return the response."</p>
<p>That means that data's gonna have to be stored somewhere, and in any real-world scenario that would have to be secured somehow. But like, the LLM itself is never actually knowing those details besides the user account it's passing in, so that seems okay.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chatbot_1.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="servicenow_1.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chatbot_1.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="servicenow_1.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
